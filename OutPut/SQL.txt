declare @FechaIni as DateTime
declare @FechaFin as DateTime
declare @Alumno as Integer
declare @AlumnoIni as Integer
declare @AlumnoFin as Integer
declare @Grupo as integer
declare @Ciclo as Integer
declare @Maestro as Integer
declare @MaestroIni as Integer
declare @MaestroFin as Integer
declare @Nivel as Integer
declare @TipoPago as Integer
declare @TipoCalificacion as Integer
declare @Usuario as Integer
declare @Familia as Integer
declare @Valor1 as Integer
declare @Status as Integer
declare @Serie as varchar(500)
declare @Factura as Integer
declare @FacturasCompras as Integer
declare @TurnoInicio as Integer
declare @TurnoFin as Integer
declare @NumeroEstacion as Integer
declare @HorarioIni as Integer
declare @HorarioFin as Integer
declare @NumeroEstacionIni as Integer
declare @NumeroEstacionFin as Integer

select @FechaIni=:FechaIni
select @FechaFin=:FechaFin
select @Alumno=:Alumno
select @AlumnoIni=:AlumnoIni
select @AlumnoFin=:AlumnoFin
select @Grupo=:Grupo
select @Ciclo=:Ciclo
select @Maestro=:Maestro
select @MaestroIni=:MaestroIni
select @MaestroFin=:MaestroFin
select @Nivel=:Nivel
select @TipoPago=:TipoPago
select @TipoCalificacion=:TipoCalificacion
select @Usuario=:Usuario
select @Familia=:Familia
select @Valor1=:Valor1
select @Status=:Status
select @Serie=:Serie
select @Factura=:Factura
select @FacturasCompras=:FacturasCompras
select @TurnoInicio=:TurnoInicio
select @TurnoFin=:TurnoFin
select @NumeroEstacion=:NumeroEstacion
select @HorarioIni=:HorarioIni
select @HorarioFin=:HorarioFin
select @NumeroEstacionIni=:NumeroEstacionIni
select @NumeroEstacionFin=:NumeroEstacionFin
Select *, @fechaini as ALaFecha from (
SELECT     A.EstacionID, A.Estacion, A.AlmacenID, A.Almacen, A.ProductoID, A.Codigo, A.Nombre, A.Existencia, ISNULL(B.Cantidad, 0) AS EnLiquidacion, A.Existencia - ISNULL(B.Cantidad, 0) AS Total
FROM         (SELECT     Estacion.EstacionID, Estacion.Nombre AS Estacion, Almacen2.AlmacenID, Almacen2.Nombre AS Almacen, Producto.ProductoID, 
                                              Producto.Codigo, Producto.Nombre, SUM(DetalleMovimientoAlmacen2.Cantidad * TipoMovimientoAlmacen2.Operador) AS Existencia
                       FROM          Almacen2 INNER JOIN
                                              MovimientoAlmacen2 ON Almacen2.AlmacenID = MovimientoAlmacen2.AlmacenID INNER JOIN
                                              DetalleMovimientoAlmacen2 ON 
                                              MovimientoAlmacen2.MovimientoAlmacenID = DetalleMovimientoAlmacen2.MovimientoAlmacenID INNER JOIN
                                              TipoMovimientoAlmacen2 ON 
                                              MovimientoAlmacen2.TipoMovimientoAlmacenID = TipoMovimientoAlmacen2.TipoMovimientoAlmacenID INNER JOIN
                                              Producto ON DetalleMovimientoAlmacen2.ProductoID = Producto.ProductoID INNER JOIN
                                              Estacion ON MovimientoAlmacen2.EstacionID = Estacion.EstacionID
                       WHERE      (Almacen2.AlmacenID = @Almacen) AND (MovimientoAlmacen2.Fecha <= @FechaINI) 
                       GROUP BY Producto.ProductoID, Producto.Codigo, Producto.Nombre, Almacen2.AlmacenID, Almacen2.Nombre, Estacion.Nombre, Estacion.EstacionID) 
                      A LEFT OUTER JOIN
                          (SELECT     DetalleLiquidacion2.ProductoID, Agrupacion2.AlmacenID, SUM(DetalleLiquidacion2.Cantidad) AS Cantidad
                            FROM          Liquidacion2 INNER JOIN
                                                   DespachadorLiquidacion2 ON Liquidacion2.LiquidacionID = DespachadorLiquidacion2.LiquidacionID INNER JOIN
                                                   DetalleLiquidacion2 ON
                                                   DespachadorLiquidacion2.DespachadorLiquidacionID = DetalleLiquidacion2.DespachadorLiquidacionID INNER JOIN
                                                   Agrupacion2 ON DespachadorLiquidacion2.AgrupacionID = Agrupacion2.AgrupacionID
                            WHERE      (Liquidacion2.Cerrada = 0) AND (DetalleLiquidacion2.TipoValorID = 14) AND (AlmacenID = @Almacen) AND (Liquidacion2.Fecha <= @FechaINI)
                            GROUP BY DetalleLiquidacion2.ProductoID, Agrupacion2.AlmacenID) B ON A.ProductoID = B.ProductoID) D
order BY Nombre
