unit ufrmInscripciones;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ufrmCatalogo, cxGraphics, cxControls, cxLookAndFeels,
  cxLookAndFeelPainters, dxSkinsCore, dxSkinBlack, dxSkinBlue, dxSkinCaramel,
  dxSkinCoffee, dxSkinDarkRoom, dxSkinDarkSide, dxSkinFoggy, dxSkinGlassOceans,
  dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky,
  dxSkinMcSkin, dxSkinMoneyTwins, dxSkinOffice2007Black, dxSkinOffice2007Blue,
  dxSkinOffice2007Green, dxSkinOffice2007Pink, dxSkinOffice2007Silver,
  dxSkinPumpkin, dxSkinSeven, dxSkinSharp, dxSkinSilver, dxSkinSpringTime,
  dxSkinStardust, dxSkinSummer2008, dxSkinsDefaultPainters, dxSkinValentine,
  dxSkinXmas2008Blue, dxSkinscxPCPainter, cxStyles, cxCustomData, cxFilter,
  cxData, cxDataStorage, cxEdit, DB, cxDBData, dxmdaset, uDAInterfaces,
  uDADataTable, uDAScriptingProvider, uDAMemDataTable, cxGridLevel, cxClasses,
  cxGridCustomView, cxGridCustomTableView, cxGridTableView, cxGridDBTableView,
  cxGrid, cxPC, cxContainer, Menus, cxImage, cxDBEdit, cxDropDownEdit,
  cxLookupEdit, cxDBLookupEdit, cxDBLookupComboBox, StdCtrls, cxButtons,
  cxGroupBox, cxRadioGroup, cxLabel, cxMaskEdit, cxCalendar, cxTextEdit,
  ExtCtrls, cxCurrencyEdit, AdvDirectoryEdit, AdvEdit, AdvEdBtn, Modules, dmActions,
  AdvFileNameEdit, TBX, TB2Item, TBXExtItems, TB2Dock, TB2Toolbar, TB2ToolWindow,
  uDARemoteDataAdapter, LibraryGauss_Intf;

type
  TfrmInscripciones = class(TfrmCatalogo)
    Panel1: TPanel;
    Panel2: TPanel;
    pgcInscripcion: TcxPageControl;
    cxTabSheet3: TcxTabSheet;
    cxDBTextEdit1: TcxDBTextEdit;
    cxDBTextEdit2: TcxDBTextEdit;
    cxDBTextEdit3: TcxDBTextEdit;
    cxLabel1: TcxLabel;
    cxLabel5: TcxLabel;
    cxLabel6: TcxLabel;
    cxLabel7: TcxLabel;
    cxLabel8: TcxLabel;
    cxLabel11: TcxLabel;
    cxLabel12: TcxLabel;
    cxDBLookupComboBox1: TcxDBLookupComboBox;
    cxTabSheet8: TcxTabSheet;
    cxDBCurrencyEdit1: TcxDBCurrencyEdit;
    cxDBCurrencyEdit2: TcxDBCurrencyEdit;
    cxTabSheet7: TcxTabSheet;
    cxGrid1DBTableView1: TcxGridDBTableView;
    cxGrid1Level1: TcxGridLevel;
    cxGrid1: TcxGrid;
    btnAgregar: TcxButton;
    btnSerie: TcxButton;
    btnDescuentaBeca: TcxButton;
    cxGrid2: TcxGrid;
    cxGridDBTableView1: TcxGridDBTableView;
    cxGridLevel1: TcxGridLevel;
    cxButton1: TcxButton;
    cxButton2: TcxButton;
    TBDock1: TTBDock;
    TBXToolbar2: TTBXToolbar;
    TBControlItem1: TTBControlItem;
    dbcCiclo: TcxLookupComboBox;
    TBXLabelItem2: TTBXLabelItem;
    TBXToolbar1: TTBXToolbar;
    TBXItem2: TTBXItem;
    TBSeparatorItem1: TTBSeparatorItem;
    btnInscribir: TTBXItem;
    dsAlumno: TDADataSource;
    cdsAlumno: TDAMemDataTable;
    cdsGrupo: TDAMemDataTable;
    dsGrupo: TDADataSource;
    cdsCualesMaterias: TDAMemDataTable;
    dsCualesMaterias: TDADataSource;
    cdsCualesPagos: TDAMemDataTable;
    dsCualesPagos: TDADataSource;
    cdsCalificaciones: TDAMemDataTable;
    dsCalificaciones: TDADataSource;
    cdsPagos: TDAMemDataTable;
    dsPagos: TDADataSource;
    cdsSubTipo: TDAMemDataTable;
    dsSubTipo: TDADataSource;
    cdsMaterias: TDAMemDataTable;
    dsMaterias: TDADataSource;
    cdsStatus: TDAMemDataTable;
    dsStatus: TDADataSource;
    dsCiclo: TDADataSource;
    cdsCiclo: TDAMemDataTable;
    dsNuevoGrupo: TDADataSource;
    cdsNuevoGrupo: TDAMemDataTable;
    cdsNuevoCiclo: TDAMemDataTable;
    dsNuevoCiclo: TDADataSource;
    cdsViejoGrupo: TDAMemDataTable;
    dsViejoGrupo: TDADataSource;
    dsViejoCiclo: TDADataSource;
    cdsViejoCiclo: TDAMemDataTable;
    cdsHistorialGrupo: TDAMemDataTable;
    cdsAlumnosPreinscripcion: TDAMemDataTable;
    cdsModificaStatus: TDAMemDataTable;
    cdsSerie: TDAMemDataTable;
    dsSerie: TDADataSource;
    dbgCatalogoDBTableView1alumnonumcontrol: TcxGridDBColumn;
    dbgCatalogoDBTableView1alumnonombre: TcxGridDBColumn;
    dbgCatalogoDBTableView1grupocodigo: TcxGridDBColumn;
    dbgCatalogoDBTableView1BECA: TcxGridDBColumn;
    dbgCatalogoDBTableView1DESCUENTO: TcxGridDBColumn;
    twPreinscripcion: TTBXToolWindow;
    cxGroupBox4: TcxGroupBox;
    Label8: TLabel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    btnAceptar: TcxButton;
    dbcViejoCiclo: TcxLookupComboBox;
    dbcViejoGrupo: TcxLookupComboBox;
    dbcNuevoCiclo: TcxLookupComboBox;
    dbcNuevoGrupo: TcxLookupComboBox;
    twPagos: TTBXToolWindow;
    cxGroupBox3: TcxGroupBox;
    Label11: TLabel;
    Label12: TLabel;
    Label14: TLabel;
    Label13: TLabel;
    cxButton5: TcxButton;
    cxDBTextEdit5: TcxDBTextEdit;
    cxDBTextEdit6: TcxDBTextEdit;
    cxDBDateEdit1: TcxDBDateEdit;
    twMaterias: TTBXToolWindow;
    cxGroupBox2: TcxGroupBox;
    Label9: TLabel;
    Label10: TLabel;
    cxButton4: TcxButton;
    dbcCodigoMateria: TcxLookupComboBox;
    dbcCodigoGrupo: TcxLookupComboBox;
    twSerie: TTBXToolWindow;
    cxGroupBox1: TcxGroupBox;
    Label7: TLabel;
    cxButton3: TcxButton;
    dbcSubTipoPago: TcxLookupComboBox;
    cdsConfiguracion: TDAMemDataTable;
    tblAux: TdxMemData;
    tblAuxidMateria: TIntegerField;
    tblAuxidGrupo: TIntegerField;
    spLimiteInscribe: TDAMemDataTable;
    spExisteAlumno: TDAMemDataTable;
    dbcGrupo: TcxDBLookupComboBox;
    spCupo: TDAMemDataTable;
    cxDBLookupComboBox2: TcxDBLookupComboBox;
    cxGrid1DBTableView1NUMPAGO: TcxGridDBColumn;
    cxGrid1DBTableView1IMPORTE: TcxGridDBColumn;
    cxGrid1DBTableView1FECHA: TcxGridDBColumn;
    cxGrid1DBTableView1STATUS: TcxGridDBColumn;
    cxGrid1DBTableView1IDSUBTIPOPAGO: TcxGridDBColumn;
    cxGridDBTableView1IDMATERIA: TcxGridDBColumn;
    cxGridDBTableView1STATUS: TcxGridDBColumn;
    cxGridDBTableView1FALTAS: TcxGridDBColumn;
    cxGridDBTableView1Column1: TcxGridDBColumn;
    cxGridDBTableView1Column2: TcxGridDBColumn;
    cxGridDBTableView1Column3: TcxGridDBColumn;
    PopupMenu1: TPopupMenu;
    Pagar1: TMenuItem;
    ImprimirRecibo1: TMenuItem;
    btnEliminar: TcxButton;
    rdaActualizaNumeroControl: TDARemoteDataAdapter;
    cdsActualizaNumeroControl: TDAMemDataTable;
    TBXSeparatorItem1: TTBXSeparatorItem;
    TBXItem1: TTBXItem;
    rdaEliminaProspecto: TDARemoteDataAdapter;
    cdsEliminaProspecto: TDAMemDataTable;
    procedure BuscarAlumno;
    procedure BuscarProspecto;
    procedure FormCreate(Sender: TObject);
    procedure dbcCicloPropertiesChange(Sender: TObject);
    procedure cdsCatalogoAfterScroll(DataTable: TDADataTable);
    procedure cdsCatalogoAfterEdit(DataTable: TDADataTable);
    procedure btnInscribirClick(Sender: TObject);
    procedure btnAgregarClick(Sender: TObject);
    procedure btnEliminarClick(Sender: TObject);
    procedure btnSerieClick(Sender: TObject);
    procedure btnDescuentaBecaClick(Sender: TObject);
    procedure cxButton2Click(Sender: TObject);
    procedure cxButton1Click(Sender: TObject);
    procedure btnAceptarClick(Sender: TObject);
    procedure cxButton4Click(Sender: TObject);
    procedure cxButton5Click(Sender: TObject);
    procedure cxButton3Click(Sender: TObject);
    procedure twSerieVisibleChanged(Sender: TObject);
    procedure cdsCatalogoBeforeEdit(DataTable: TDADataTable);
    procedure cdsCatalogoNewRecord(DataTable: TDADataTable);
    procedure TBXItem2Click(Sender: TObject);
    procedure twPreinscripcionVisibleChanged(Sender: TObject);
    procedure cdsPagosNewRecord(DataTable: TDADataTable);
    procedure cdsCalificacionesNewRecord(DataTable: TDADataTable);
    procedure cxGridDBTableView1CellDblClick(Sender: TcxCustomGridTableView;
      ACellViewInfo: TcxGridTableDataCellViewInfo; AButton: TMouseButton;
      AShift: TShiftState; var AHandled: Boolean);
    procedure cxGrid1DBTableView1CellDblClick(Sender: TcxCustomGridTableView;
      ACellViewInfo: TcxGridTableDataCellViewInfo; AButton: TMouseButton;
      AShift: TShiftState; var AHandled: Boolean);
    procedure twPagosVisibleChanged(Sender: TObject);
    procedure twPagosCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure twMateriasCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure Pagar1Click(Sender: TObject);
    procedure ImprimirRecibo1Click(Sender: TObject);
    procedure dbgCatalogoDBTableView1DblClick(Sender: TObject);
    procedure dbcGrupoPropertiesValidate(Sender: TObject;
      var DisplayValue: Variant; var ErrorText: TCaption; var Error: Boolean);
    procedure TBXItem1Click(Sender: TObject);
  private
    { Private declarations }
    procedure ActionGuardar(Action: TBasicAction); override;
    procedure ActionNuevo(Action: TBasicAction); override;
    procedure ActionEliminar(Action: TBasicAction);
    procedure ActionCancelar(Action: TBasicAction);
  protected
    procedure UpdateActionsState; override;
    procedure RegisterActions; override;
  public
    { Public declarations }
    idHistorialAlumno : Integer;
    idHIstorialGrupo : Integer;
    idGrupo : Integer;
    Inscrito : Boolean;
    CambioGrupo : Integer;
    procedure AgregaPagos(NumPagos, IdSubTipoPago, Plazo : Integer; Importe, Beca, Descuento : Real; Fecha : TDateTime);
    procedure ActionActualizar(Action: TBasicAction); override;
  end;

var
  frmInscripciones: TfrmInscripciones;

implementation

uses uDM, ufrmBuscar, ufrmBuscarAlumno, ufrmBuscarProspecto, ufrmAgregarAlumno;

{$R *.dfm}

procedure TfrmInscripciones.ActionActualizar(Action: TBasicAction);
begin
  inherited;

end;

procedure TfrmInscripciones.ActionCancelar(Action: TBasicAction);
begin
  cdsAlumno.Close;
  Inscrito:=False;
  pgcInscripcion.ActivePageIndex:=0;
end;

procedure TfrmInscripciones.ActionEliminar(Action: TBasicAction);
begin
  DM.Servidor.HistorialAlumnoDEL(idHistorialAlumno);
  cdsCatalogo.Refresh;
  pgcCatalogo.ActivePageIndex:= 0;
end;

procedure TfrmInscripciones.ActionGuardar(Action: TBasicAction);
var
  P: TParametrosF;
  S: String;

begin
  if Inscrito then
  begin
    if cdsCatalogo.State = dsInsert then
      DM.Servidor.InsertaHistorialAlumno(cdsCatalogo.FieldByName('IDHISTORIALALUMNO').AsInteger,
                                         cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger,
                                         cdsCatalogo.FieldByName('IDALUMNO').AsInteger,
                                         cdsCatalogo.FieldByName('DOCUMENTOSFALTANTES').AsString,
                                         cdsCatalogo.FieldByName('BECA').AsFloat,
                                         cdsCatalogo.FieldByName('DESCUENTO').AsFloat)
    else
      DM.Servidor.CambioGrupo(cdsCatalogo.FieldByName('IDHISTORIALALUMNO').AsInteger,
                                         cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger,
                                         cdsCatalogo.FieldByName('DOCUMENTOSFALTANTES').AsString,
                                         cdsCatalogo.FieldByName('BECA').AsFloat,
                                         cdsCatalogo.FieldByName('DESCUENTO').AsFloat);

    cdsCatalogo.Post;
    cdsPagos.ApplyUpdates();
    cdsCalificaciones.ApplyUpdates();
    Inscrito:=False;

    ////actualiza numero de control del alumno//////////////////////////////////
           P:=TParametrosF.Create;
           try
           cdsConfiguracion.Close;
           cdsConfiguracion.Open;
           cdsActualizaNumeroControl.Close;
           P.Alumno:=DM.idAlumnoEncontrado;

           S:=cdsConfiguracion.FieldByName('FORMATOCONTROL').AsString;
           rdaActualizaNumeroControl.GetDataCall.ParamByName('SQL').AsString:=S;
           rdaActualizaNumeroControl.GetDataCall.ParamByName('Parametros').AsComplexType:=P;
           cdsActualizaNumeroControl.Open;
           finally FreeAndNil(P); end;
////////////////////////////////////////////////////////////////////////////////
  cdsCatalogo.Refresh;
  end
  else
    DM.Mensaje('Información', 15, False, Informacion, []);
end;

procedure TfrmInscripciones.ActionNuevo(Action: TBasicAction);
var
  Ok : Boolean;
begin
  spLimiteInscribe.Close;
  spLimiteInscribe.ParamByName('idHistorialGrupo').AsInteger:=cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger;
  spLimiteInscribe.Open;
  if spLimiteInscribe.FieldByName('inscribir').AsInteger = 1 then
  begin
    DM.Mensaje('Información', 29, False, Informacion, []);
    Exit;
  end;

  if Action <> nil then
  begin
    DM.idAlumnoEncontrado:=0;
    BuscarAlumno;
  end;
  Ok:=False;
  if (DM.idAlumnoEncontrado > 0) then
  begin
    Ok:=True;
    spExisteAlumno.ParamByName('idAlumno').AsInteger:=DM.idAlumnoEncontrado;
    spExisteAlumno.ParamByName('idCiclo').AsInteger:=dbcCiclo.EditValue;
    spExisteAlumno.Open;
    if spExisteAlumno.FieldByName('Existe').AsInteger > 0 then
      Ok:=DM.Mensaje('Información', 9, True, Informacion, []) = ID_YES;
  end;
  if (Action = nil) and (Ok=False) then
  begin
    cdsCatalogo.Cancel;
    Close;
  end;
  if Ok then
  begin
    cdsAlumno.Close;
    cdsAlumno.ParamByName('idAlumno').AsInteger:=DM.idAlumnoEncontrado;
    cdsAlumno.Open;

    idHistorialAlumno:= DM.Servidor.Folio('IDHISTORIALALUMNO','');

    if spLimiteInscribe.FieldByName('inscribir').AsInteger = 1 then
       cdsCatalogo.Edit
    else cdsCatalogo.Append;

    cdsCatalogo.FieldByName('idhistorialalumno').AsInteger:=idHistorialAlumno;
    cdsCatalogo.FieldByName('alumnonumcontrol').AsString:=cdsAlumno.FieldByName('NUMCONTROL').AsString;
    cdsCatalogo.FieldByName('alumnonombre').AsString:=cdsAlumno.FieldByName('NOMBRE').AsString;
    cdsCatalogo.FieldByName('idalumno').AsInteger:=cdsAlumno.FieldByName('IDALUMNO').AsInteger;

    cdsCatalogo.FieldByName('documentosfaltantes').AsString:='';
    cdsCatalogo.FieldByName('Beca').AsFloat:=0;
    cdsCatalogo.FieldByName('DESCUENTO').AsFloat:=0;
    cdsCatalogo.FieldByName('documentosfaltantes').AsString:='';
    cdsCatalogo.FieldByName('idStatus').AsInteger:=1;

    cdsPagos.Close;
    cdsPagos.ParamByName('idhistorialalumno').AsInteger:= idHistorialAlumno;
    cdsPagos.Open;
    cdsCalificaciones.Close;
    cdsCalificaciones.ParamByName('idhistorialalumno').AsInteger:= idHistorialAlumno;
    cdsCalificaciones.Open;

    pgcCatalogo.ActivePageIndex:= 1;
    pgcInscripcion.ActivePageIndex:=0;

    dbcGrupo.SetFocus;
  end
  else
    ActionCancelar(nil);
end;

procedure TfrmInscripciones.AgregaPagos(NumPagos, IdSubTipoPago, Plazo: Integer;
  Importe, Beca, Descuento: Real; Fecha: TDateTime);
var
  i : integer;
begin
  for i:=1 to NumPagos do
  begin
    cdsPagos.Append;
    cdsPagos.FieldByName('NUMPAGO').AsInteger:=i;
    cdsPagos.FieldByName('IMPORTE').AsFloat:=Importe;
    cdsPagos.FieldByName('FECHA').AsDateTime:=DM.Fecha(Fecha, i-1, Plazo);
    cdsPagos.FieldByName('IDSUBTIPOPAGO').AsInteger:=IdSubTipoPago;
    cdsPagos.Post;
  end;
  cdsCatalogo.Edit;
end;

procedure TfrmInscripciones.btnAceptarClick(Sender: TObject);
begin
  inherited;
  if (dbcViejoCiclo.EditValue <> null) and (dbcViejoGrupo.EditValue <> null) and
     (dbcNuevoCiclo.EditValue <> null) and (dbcNuevoGrupo.EditValue <> null) and
     (dbcViejoCiclo.EditValue <> dbcNuevoCiclo.EditValue) and
     (dbcViejoGrupo.EditValue <> dbcNuevoGrupo.EditValue) then
  begin
    cdsAlumnosPreinscripcion.ParamByName('idCiclo').AsInteger:=dbcViejoCiclo.EditValue;
    cdsAlumnosPreinscripcion.ParamByName('idGrupo').AsInteger:=dbcViejoGrupo.EditValue;
    cdsAlumnosPreinscripcion.Open;
    cdsHistorialGrupo.ParamByName('idCiclo').AsInteger:=dbcNuevoCiclo.EditValue;
    cdsHistorialGrupo.ParamByName('idGrupo').AsInteger:=dbcNuevoGrupo.EditValue;
    cdsHistorialGrupo.Open;
    idHIstorialGrupo:=cdsHistorialGrupo.FieldByName('IDHISTORIALGRUPO').AsInteger;
    idGrupo:=dbcNuevoGrupo.EditValue;
    while not cdsAlumnosPreInscripcion.Eof do
    begin
      spExisteAlumno.ParamByName('idAlumno').AsInteger:=cdsAlumnosPreInscripcion.FieldByName('IDALUMNO').AsInteger;
      spExisteAlumno.ParamByName('idCiclo').AsInteger:=dbcNuevoCiclo.EditValue;
      spExisteAlumno.Open;
      cdsAlumnosPreInscripcion.Next;
    end;
      if spExisteAlumno.FieldByName('Existe').AsInteger = 0 then
      begin
        cdsCatalogo.Append;
        idHistorialAlumno:= DM.Servidor.Folio('IDHISTORIALALUMNO','');
        cdsCatalogo.FieldByName('IDHISTORIALALUMNO').AsInteger:=idHistorialAlumno;
        cdsCatalogo.FieldByName('IDALUMNO').AsInteger:=cdsAlumnosPreInscripcion.FieldByName('IDALUMNO').AsInteger;
        cdsCatalogo.FieldByName('ALUMNONUMCONTROL').AsString:=cdsAlumnosPreInscripcion.FieldByName('ALUMNONUMCONTROL').AsString;
        cdsCatalogo.FieldByName('ALUMNONOMBRE').AsString:=cdsAlumnosPreInscripcion.FieldByName('ALUMNONOMBRE').AsString;
        cdsCatalogo.FieldByName('IDSTATUS').AsInteger:=4;
        cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger:=cdsHistorialGrupo.FieldByName('IDHISTORIALGRUPO').AsInteger;
        btnInscribirClick(nil);
        //actGuardarExecute(btnGuardar);
        ActionGuardar(nil);
      end;
      cdsAlumnosPreInscripcion.Next;
    end;
    cdsAlumnosPreInscripcion.Close;
    cdsHistorialGrupo.Close;
    twPreinscripcion.Visible:=False;
end;

procedure TfrmInscripciones.btnAgregarClick(Sender: TObject);
begin
  inherited;
  twPagos.Visible:=True;
  cdsPagos.Last;
  cdsPagos.Append;
end;

procedure TfrmInscripciones.btnDescuentaBecaClick(Sender: TObject);
begin
  inherited;
  if DM.Mensaje('Confirmar', 37, True, Confirmar, [FormatFloat('#0.00%', cdsCatalogo.FieldByName('BECA').AsFloat), FormatFloat('#0.00%', cdsCatalogo.FieldByName('DESCUENTO').AsFloat)]) = ID_YES then
  begin
    DM.Servidor.BecaDescuento(cdsCatalogo.FieldByName('IDHISTORIALALUMNO').AsInteger,
                              cdsCatalogo.FieldByName('BECA').AsFloat,
                              cdsCatalogo.FieldByName('DESCUENTO').AsFloat);
    cdsPagos.Close;
    cdsPagos.Open;
    cdsCatalogo.Cancel;
  end;
end;

procedure TfrmInscripciones.btnEliminarClick(Sender: TObject);
begin
  inherited;
  if cdsPagos.RecordCount > 0 then
     cdsPagos.Delete;
  cdsCatalogo.Edit;
  UpdateActionsState;
end;

procedure TfrmInscripciones.btnSerieClick(Sender: TObject);
begin
  inherited;
  twSerie.Visible:=True;
end;

procedure TfrmInscripciones.BuscarAlumno;
var
   Datos: TDatosBusqueda;
begin
   Datos:=PantallaBusqueda(TfrmBuscarAlumno,'');
   if Datos.OK then
   begin
      DM.idAlumnoEncontrado := Datos.Clave;
   end;
end;

procedure TfrmInscripciones.BuscarProspecto;
var
   Datos: TDatosBusqueda;
begin
   Datos:=PantallaBusqueda(TfrmBuscarProspecto,'');
   if Datos.OK then
   begin
      DM.idAlumnoEncontrado := Datos.Clave;
   end else DM.idAlumnoencontrado:= 0;
end;

procedure TfrmInscripciones.cdsCalificacionesNewRecord(DataTable: TDADataTable);
begin
  inherited;
  cdsCalificaciones.FieldByName('IDCALIFICACION').AsInteger:= DM.Servidor.Folio('IDCALIFICACION','');
  cdsCalificaciones.FieldByName('IDHISTORIALALUMNO').AsInteger:=idHistorialAlumno;
  cdsCalificaciones.FieldByName('IDHISTORIALGRUPO').AsInteger:=idHIstorialGrupo;
  cdsCalificaciones.FieldByName('FALTAS').AsInteger:=0;
  cdsCalificaciones.FieldByName('IDTIPOCALIFICACION').AsInteger:=1;
  cdsCalificaciones.FieldByName('STATUS').AsString:='C';
end;

procedure TfrmInscripciones.cdsCatalogoAfterEdit(DataTable: TDADataTable);
begin
  inherited;
  Inscrito:=True;
end;

procedure TfrmInscripciones.cdsCatalogoAfterScroll(DataTable: TDADataTable);
begin
  inherited;
  Panel1.Caption:=Format(' Alumno [%s]', [cdsCatalogo.FieldByName('ALUMNONOMBRE').AsString]);
  if cdsCatalogo.State = dsBrowse then
    idHistorialAlumno:=cdsCatalogo.FieldByName('IDHISTORIALALUMNO').AsInteger;
end;

procedure TfrmInscripciones.cdsCatalogoBeforeEdit(DataTable: TDADataTable);
begin
  inherited;
  CambioGrupo:=cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger;
end;

procedure TfrmInscripciones.cdsCatalogoNewRecord(DataTable: TDADataTable);
begin
  inherited;
  cdsCatalogo.FieldByName('BECA').AsFloat:=0;
  cdsCatalogo.FieldByName('DESCUENTO').AsFloat:=0;
end;

procedure TfrmInscripciones.cdsPagosNewRecord(DataTable: TDADataTable);
begin
  inherited;
  cdsPagos.FieldByName('IDPAGO').AsInteger:=DM.Servidor.Folio('IDPAGO','');
  cdsPagos.FieldByName('STATUS').AsString:='D';
  cdsPagos.FieldByName('INTERES').AsInteger:=0;
  cdsPagos.FieldByName('EMITIDO').AsInteger:=0;
  cdsPagos.FieldByName('IDEMPLEADO').AsInteger:=DM.EmpleadoID;
  cdsPagos.FieldByName('IDHISTORIALALUMNO').AsInteger:=idHistorialAlumno;
end;

procedure TfrmInscripciones.cxButton1Click(Sender: TObject);
begin
  inherited;
  if cdsCalificaciones.RecordCount > 0 then
     cdsCalificaciones.Delete;
  cdsCatalogo.Edit;
  UpdateActionsState;
end;

procedure TfrmInscripciones.cxButton2Click(Sender: TObject);
begin
  inherited;
  twMaterias.Visible:=True;
  tblAux.Close;
  tblAux.Open;
end;

procedure TfrmInscripciones.cxButton3Click(Sender: TObject);
var
  Beca, Descuento : Real;
begin
  inherited;
  cdsSerie.Locate('IDSUBTIPOPAGO', dbcSubTipoPago.EditValue, []);
  
  Beca:=0;
  Descuento:=0;
  if cdsSerie.FieldByName('APLICABECA').AsInteger = 1 then
    Beca:=cdsCatalogo.FieldByName('BECA').AsFloat;
  if cdsSerie.FieldByName('APLICADESCUENTO').AsInteger = 1 then
    Descuento:=cdsCatalogo.FieldByName('DESCUENTO').AsFloat;
  AgregaPagos(cdsSerie.FieldByName('NUMPAGOS').AsInteger, cdsSerie.FieldByName('IDSUBTIPOPAGO').AsInteger, cdsSerie.FieldByName('PLAZO').AsInteger,
              cdsSerie.FieldByName('IMPORTE').AsFloat, Beca, Descuento, cdsSerie.FieldByName('FECHA').AsDateTime);
  twSerie.Visible:=False;

  UpdateActionsState;
end;

procedure TfrmInscripciones.cxButton4Click(Sender: TObject);
begin
  inherited;
  if (dbcCodigoMateria.EditValue<>null) and (dbcCodigoGrupo.EditValue<>null) and (not cdsCalificaciones.Locate('idMateria', dbcCodigoMateria.EditValue, [])) then
  begin
    cdsCalificaciones.Append;
    cdsCalificaciones.FieldByName('IDMATERIA').AsInteger:=dbcCodigoMateria.EditValue;
    cdsCalificaciones.FieldByName('IDHISTORIALGRUPO').AsInteger:=dbcCodigoGrupo.EditValue;
    cdsCalificaciones.Post;
  end;
  cdsCatalogo.Edit;
  twMaterias.Visible:=False;

  UpdateActionsState
end;

procedure TfrmInscripciones.cxButton5Click(Sender: TObject);
begin
  inherited;
  if (cdsPagos.FieldByName('NUMPAGO').AsInteger > 0) and (cdsPagos.FieldByName('IMPORTE').AsInteger > 0) and
     (cdsPagos.FieldByName('IDSUBTIPOPAGO').AsInteger > 0) and (cdsPagos.FieldByName('FECHA').AsDateTime > 0) then
  begin
    if cdsPagos.State in dsEditModes then
      cdsPagos.Post;
    twPagos.Visible:=False;
  end;
end;

procedure TfrmInscripciones.cxGrid1DBTableView1CellDblClick(
  Sender: TcxCustomGridTableView; ACellViewInfo: TcxGridTableDataCellViewInfo;
  AButton: TMouseButton; AShift: TShiftState; var AHandled: Boolean);
begin
  inherited;
  if cdsCatalogo.State in dsEditModes then
     twPagos.Visible:=True;
end;

procedure TfrmInscripciones.cxGridDBTableView1CellDblClick(
  Sender: TcxCustomGridTableView; ACellViewInfo: TcxGridTableDataCellViewInfo;
  AButton: TMouseButton; AShift: TShiftState; var AHandled: Boolean);
begin
  inherited;
  if cdsCatalogo.State in dsEditModes then
     twMaterias.Visible:=True;
end;

procedure TfrmInscripciones.dbcCicloPropertiesChange(Sender: TObject);
begin
  inherited;
  cdsCatalogo.Close;
  cdsGrupo.Close;
  cdsCatalogo.ParamByName('idCiclo').AsInteger:= dbcCiclo.EditValue;
  cdsGrupo.ParamByName('idCiclo').AsInteger:= dbcCiclo.EditValue;
  cdsGrupo.Open;
  cdsCatalogo.Open;
end;

procedure TfrmInscripciones.dbcGrupoPropertiesValidate(Sender: TObject;
  var DisplayValue: Variant; var ErrorText: TCaption; var Error: Boolean);
begin
  inherited;
  cdsGrupo.Locate('IDHISTORIALGRUPO', dbcGrupo.EditValue, []);
end;

procedure TfrmInscripciones.dbgCatalogoDBTableView1DblClick(Sender: TObject);
begin
  inherited;
    cdsPagos.Close;
    cdsPagos.ParamByName('idhistorialalumno').AsInteger:= idHistorialAlumno;
    cdsPagos.Open;
    cdsCalificaciones.Close;
    cdsCalificaciones.ParamByName('idhistorialalumno').AsInteger:= idHistorialAlumno;
    cdsCalificaciones.Open;
end;

procedure TfrmInscripciones.FormCreate(Sender: TObject);
begin
  inherited;
  Inscrito:= False;
  DM.IniciaVentana(twMaterias);
  DM.IniciaVentana(twPagos);
  DM.IniciaVentana(twSerie);
  DM.IniciaVentana(twPreinscripcion);
  btnEliminar.Visible:=True;
  Campo:='IDHISTORIALALUMNO';
  cdsCiclo.Open;
  cdsStatus.Open;
  cdsGrupo.Open;
  cdsSubTipo.Open;
  cdsMaterias.Open;
  cdsCalificaciones.Open;
  cdsPagos.Open;
  tblAux.Open;
  dbcCiclo.EditValue :=cdsConfiguracion.FieldByName('CICLOACTUAL').AsInteger;

  dbcCicloPropertiesChange(Nil);
end;

procedure TfrmInscripciones.ImprimirRecibo1Click(Sender: TObject);
begin
  inherited;
  {repReservacion.Template.LoadFromDatabase;
  repReservacion.ShowAutoSearchDialog:=False;
  repReservacion.PrinterSetup.DocumentName:='Reservación';
  repReservacion.Print;}
end;

procedure TfrmInscripciones.Pagar1Click(Sender: TObject);
begin
  inherited;
  if cdsPagos.FieldByName('STATUS').AsString = 'D' then
    DM.AbreCaja(cdsPagos.fieldbyName('IDPAGO').AsInteger, cdsCatalogo.FieldByName('IDALUMNO').AsInteger);
end;

procedure TfrmInscripciones.RegisterActions;
begin
  inherited;
  RegisterAction(AppActions.actNuevo, ActionNuevo);
  RegisterAction(AppActions.actGuardar, ActionGuardar);
  RegisterAction(AppActions.actEliminar, ActionEliminar);
  RegisterAction(AppActions.actCancelar, ActionCancelar);
end;

procedure TfrmInscripciones.TBXItem1Click(Sender: TObject);
var
  MiProspecto: Integer;
  P: TParametrosF;
  S: String;
begin
  inherited;
  BuscarProspecto;
  MiProspecto:=DM.idAlumnoEncontrado;
  if (MiProspecto > 0) then
  begin
    if AgregarAlumno(MiProspecto) then
    begin
      ////actualiza calificacion segun periodo////////////////////////////////////////
           P:=TParametrosF.Create;
           try
           cdsEliminaProspecto.Close;
           P.Alumno:=MiProspecto;

           S:='DELETE FROM PROSPECTO' +
              ' WHERE IDPROSPECTO ='+INTTOSTR(P.Alumno) +
              ' SELECT 1';
           rdaEliminaProspecto.GetDataCall.ParamByName('SQL').AsString:=S;
           rdaEliminaProspecto.GetDataCall.ParamByName('Parametros').AsComplexType:=P;
           cdsEliminaProspecto.Open;
           finally FreeAndNil(P); end;
////////////////////////////////////////////////////////////////////////////////
      Showmessage('Prospecto ingresado a catalogo de Alumnos');
    end;
  end;
end;

procedure TfrmInscripciones.TBXItem2Click(Sender: TObject);
begin
  inherited;
  twPreinscripcion.Visible:=True;
end;

procedure TfrmInscripciones.twMateriasCloseQuery(Sender: TObject;
  var CanClose: Boolean);
begin
  inherited;
  CanClose:=True;
  if cdsCalificaciones.State in dsEditModes then
     cdsCalificaciones.Cancel;
end;

procedure TfrmInscripciones.twPagosCloseQuery(Sender: TObject;
  var CanClose: Boolean);
begin
  inherited;
  CanClose:=True;
  if cdsPagos.State in dsEditModes then
    cdsPagos.Cancel;
end;

procedure TfrmInscripciones.twPagosVisibleChanged(Sender: TObject);
begin
  inherited;
  if twPagos.Visible then
    cdsPagos.FieldByName('FECHA').DisplayFormat:='dd/mm/yyyy'
  else
    cdsPagos.FieldByName('FECHA').DisplayFormat:='ddd dd/mmm/yyyy';
end;

procedure TfrmInscripciones.twPreinscripcionVisibleChanged(Sender: TObject);
begin
  inherited;
  cdsNuevoCiclo.Active:=twPreinscripcion.Visible;
  cdsViejoCiclo.Active:=twPreinscripcion.Visible;
  cdsNuevoGrupo.Active:=twPreinscripcion.Visible;
  cdsViejoGrupo.Active:=twPreinscripcion.Visible;
end;

procedure TfrmInscripciones.twSerieVisibleChanged(Sender: TObject);
begin
  inherited;
  cdsSerie.Active:=twSerie.Visible;
end;

procedure TfrmInscripciones.btnInscribirClick(Sender: TObject);
var
  Beca, Descuento : Real;
begin
  inherited;
//*** Generar materias correspondientes al grupo en que se inscribe el alumno
  spCupo.Close;
  spCupo.ParamByName('idHistorialGrupo').AsInteger:=cdsCatalogo.FieldByName('IDHISTORIALGRUPO').AsInteger;
  spCupo.Open;

  if (cdsGrupo.fieldbyName('CUPO').AsInteger = 0) or (spCupo.fieldbyName('Cupo').AsInteger < cdsGrupo.FieldByName('CUPO').AsInteger) then
  begin
    Inscrito:=True;
    if Sender <> nil then
    begin
      idHIstorialGrupo:=cdsGrupo.FieldByName('IDHISTORIALGRUPO').AsInteger;
      idGrupo:=cdsGrupo.FieldByName('IDGRUPO').AsInteger;
    end;
    cdsCalificaciones.Close;
    cdsCalificaciones.Open;
    while not cdsCalificaciones.Eof do
      cdsCalificaciones.Delete;
    cdsCualesMaterias.Close;
    cdsCualesMaterias.ParamByName('idgrupo').AsInteger:=idGrupo;
    cdsCualesMaterias.Open;
    cdsCualesMaterias.First;
    while not cdsCualesMaterias.Eof do
    begin
      cdsCalificaciones.Append;
      cdsCalificaciones.FieldByName('IDMATERIA').AsInteger:=cdsCualesMaterias.FieldByName('IDMATERIA').AsInteger;
      cdsCalificaciones.Post;
      cdsCualesMaterias.Next;
    end;
  //*** Generar los pagos requeridos
    cdsPagos.Close;
    cdsPagos.Open;
    while not cdsPagos.Eof do
      cdsPagos.Delete;
    cdsCualesPagos.Close;
    cdsCualesPagos.ParamByName('idgrupo').AsInteger:=idGrupo;
    cdsCualesPagos.Open;
    cdsCualesPagos.First;
    while not cdsCualesPagos.Eof do
    begin
      Beca:=0;
      Descuento:=0;
      if cdsCualesPagos.FieldByName('APLICABECA').AsInteger = 1 then
        Beca:=cdsCatalogo.FieldByName('BECA').AsFloat;
      if cdsCualesPagos.FieldByName('APLICADESCUENTO').AsInteger = 1 then
        Descuento:=cdsCatalogo.FieldByName('DESCUENTO').AsFloat;
      AgregaPagos(cdsCualesPagos.FieldByName('NUMPAGOS').AsInteger, cdsCualesPagos.FieldByName('IDSUBTIPOPAGO').AsInteger,
                  cdsCualesPagos.FieldByName('PLAZO').AsInteger, cdsCualesPagos.FieldByName('IMPORTE').AsFloat, Beca, Descuento, cdsCualesPagos.FieldByName('FECHA').AsDateTime);
      cdsCualesPagos.Next;
    end;
  end
  else
    DM.Mensaje('Información', 14, False, Informacion, []);
end;

procedure TfrmInscripciones.UpdateActionsState;
begin
  inherited;
  dmAppActions.actGuardar.Enabled:= ((cdsCatalogo.State = dsEdit)or
                                     (cdsPagos.State = dsEdit)or
                                     (cdsCalificaciones.State = dsEdit)OR
                                     (cdsCatalogo.State = dsInsert));

  dmAppActions.actCancelar.Enabled:= (cdsCatalogo.State = dsInsert);
  dmAppActions.actNuevo.Enabled:= (cdsCatalogo.State = dsBrowse);
  dmAppActions.actEliminar.Enabled:=(cdsCatalogo.State = dsBrowse);
end;

initialization
  ModuleInfoManager.RegisterModule('Inscripciones', TfrmInscripciones);

end.
