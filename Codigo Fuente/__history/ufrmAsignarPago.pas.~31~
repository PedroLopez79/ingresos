unit ufrmAsignarPago;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, CustomModule, ExtCtrls, StdCtrls, TB2Dock, TBXDkPanels, cxGraphics,
  cxControls, cxLookAndFeels, cxLookAndFeelPainters, cxContainer, cxEdit,
  dxSkinsCore, dxSkinBlack, dxSkinBlue, dxSkinCaramel, dxSkinCoffee,
  dxSkinDarkRoom, dxSkinDarkSide, dxSkinFoggy, dxSkinGlassOceans,
  dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky,
  dxSkinMcSkin, dxSkinMoneyTwins, dxSkinOffice2007Black, dxSkinOffice2007Blue,
  dxSkinOffice2007Green, dxSkinOffice2007Pink, dxSkinOffice2007Silver,
  dxSkinPumpkin, dxSkinSeven, dxSkinSharp, dxSkinSilver, dxSkinSpringTime,
  dxSkinStardust, dxSkinSummer2008, dxSkinsDefaultPainters, dxSkinValentine,
  dxSkinXmas2008Blue, cxTextEdit, cxMaskEdit, cxDropDownEdit, cxLookupEdit,
  cxDBLookupEdit, cxDBLookupComboBox, Menus, cxButtons, uDAScriptingProvider,
  uDADataTable, uDAMemDataTable, DB, uDAInterfaces, uDACDSDataTable, Modules,
  cxGroupBox, cxRadioGroup;

type
  TfrmAsignarPago = class(TfrmCustomModule)
    Panel1: TPanel;
    Panel2: TPanel;
    TBXDockablePanel1: TTBXDockablePanel;
    rbAsignarPago: TRadioButton;
    rbEliminar: TRadioButton;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    btnAsignar: TcxButton;
    dsAlumnos: TDADataSource;
    cdsAlumnos: TDAMemDataTable;
    cdsSubTipoPago: TDACDSDataTable;
    cdsCiclo: TDACDSDataTable;
    dsGrupo: TDADataSource;
    dsCiclo: TDADataSource;
    cdsGrupo: TDACDSDataTable;
    dsSubTipoPago: TDADataSource;
    cdsPago: TDACDSDataTable;
    dsPago: TDADataSource;
    dbcCiclo: TcxLookupComboBox;
    dbcGrupo: TcxLookupComboBox;
    dbcSubTipoPago: TcxLookupComboBox;
    Eliminar: TcxRadioGroup;
    procedure FormCreate(Sender: TObject);
    procedure rbEliminarClick(Sender: TObject);
    procedure rbAsignarPagoClick(Sender: TObject);
    procedure btnAsignarClick(Sender: TObject);
    procedure cdsPagoNewRecord(DataTable: TDADataTable);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure AgregaPagos(NumPagos, IdSubTipoPago, Plazo : Integer; Importe: Real; Fecha: TDateTime);
  end;

var
  frmAsignarPago: TfrmAsignarPago;

implementation

Uses uDM;

{$R *.dfm}

procedure TfrmAsignarPago.AgregaPagos(NumPagos, IdSubTipoPago, Plazo: Integer;
  Importe: Real; Fecha: TDateTime);
var
  i : Integer;
begin
  cdsPago.Open;
  for i := 1 to NumPagos do
  begin
    cdsPago.Append;
    cdsPago.FieldByName('NUMPAGO').AsInteger:= i;
    cdsPago.FieldByName('IMPORTE').AsFloat:= Importe;
    cdsPago.FieldByName('FECHA').AsDateTime:= DM.Fecha(Fecha, i-1, Plazo);
    cdsPago.FieldByName('IDSUBTIPOPAGO').AsInteger:= IdSubTipoPago;
    cdsPago.Post;
  end;
  cdsPago.ApplyUpdates();
  showmessage('Pago Asignado');
  cdsPago.Close;
end;

procedure TfrmAsignarPago.btnAsignarClick(Sender: TObject);
var
  Elimina: String;
begin
  inherited;
  Elimina:= 'P';
  if (dbcCiclo.EditValue <> null) and (dbcGrupo.EditValue <> null) and (dbcSubTipoPago.EditValue <> null) then
  begin
     if rbAsignarPago.Checked = True then
     begin
       cdsAlumnos.Close;
       cdsAlumnos.ParamByName('IDCICLO').AsInteger:= dbcCiclo.EditValue;
       cdsAlumnos.ParamByName('IDGRUPO').AsInteger:= dbcGrupo.EditValue;
       cdsAlumnos.Open;
       while not cdsAlumnos.EOF do
       begin
          cdsSubTipoPago.Locate('IDSUBTIPOPAGO', dbcSubTipoPago.EditValue, []);
          AgregaPagos(cdsSubTipoPago.FieldByName('NUMPAGOS').AsInteger,
                      cdsSubTipoPago.FieldByName('IDSUBTIPOPAGO').AsInteger,
                      cdsSubTipoPago.FieldByName('PLAZO').AsInteger,
                      cdsSubTipoPago.FieldByName('IMPORTE').AsFloat,
                      cdsSubTipoPago.FieldByName('FECHA').AsDateTime);
          cdsAlumnos.Next;
       end;
       cdsAlumnos.Close;
       cdsPago.Close;
     end else
     begin
       if Eliminar.ItemIndex = 1 then Elimina:= 'PD';
       DM.Servidor.EliminaPago(dbcSubTipoPago.EditValue,Elimina,dbcCiclo.EditValue,dbcGrupo.EditValue);
       DM.Servidor.EliminaPagoCaja(dbcSubTipoPago.EditValue,Elimina,dbcCiclo.EditValue,dbcGrupo.EditValue);
       showmessage('Pagos Eliminados');

     end;
  end else
  begin
    DM.Mensaje('Error',32, False, Error, []);
  end;
  
end;

procedure TfrmAsignarPago.cdsPagoNewRecord(DataTable: TDADataTable);
begin
  inherited;
  cdsPago.FieldByName('IDPAGO').AsInteger:=DM.Servidor.Folio('IDPAGO','');
  cdsPago.FieldByName('STATUS').AsString:= 'D';
  cdsPago.FieldByName('INTERES').AsInteger:=0;
  cdsPago.FieldByName('EMITIDO').AsInteger:=0;
  cdsPago.FieldByName('IDEMPLEADO').AsInteger:= DM.EmpleadoID;
  cdsPago.FieldByName('IDHISTORIALALUMNO').AsInteger:= cdsAlumnos.FieldByName('IDHISTORIALALUMNO').AsInteger;
end;

procedure TfrmAsignarPago.FormCreate(Sender: TObject);
begin
  inherited;
  cdsCiclo.Close;
  cdsCiclo.Open;
  cdsGrupo.Close;
  cdsGrupo.Open;
  cdsSubTipoPago.Close;
  cdsSubTipoPago.Open;
end;


procedure TfrmAsignarPago.rbAsignarPagoClick(Sender: TObject);
begin
  inherited;
  Eliminar.Visible:= False;
end;

procedure TfrmAsignarPago.rbEliminarClick(Sender: TObject);
begin
  inherited;
  Eliminar.Visible:= True;
end;

initialization
  ModuleInfoManager.RegisterModule('AsignarPagos', TfrmAsignarPago);

end.
