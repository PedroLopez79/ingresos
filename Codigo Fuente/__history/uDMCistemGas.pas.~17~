unit uDMCistemGas;

interface

uses
  SysUtils, Classes, TXComp, TXRB, ppBands, ppCache, ppClass, ppProd, ppReport,
  ppComm, ppRelatv, ppDB, ppDBPipe, DB, uDAInterfaces, uDADataTable,
  uDAMemDataTable, uDADataStreamer, uDABin2DataStreamer, uDARemoteDataAdapter,
  uDAScriptingProvider, uDACDSDataTable, uRORemoteService, uROClient,
  uROBinMessage, uROWinInetHttpChannel, LibraryCistemGas_Intf, ppTypes;

type
  TDMCistemGas = class(TDataModule)
    Channel: TROWinInetHTTPChannel;
    Message: TROBinMessage;
    RemoteService: TRORemoteService;
    cdsDatos: TDACDSDataTable;
    rdaDatos: TDARemoteDataAdapter;
    DataStreamer: TDABin2DataStreamer;
    RemoteDataAdapter: TDARemoteDataAdapter;
    cdsMaestro: TDAMemDataTable;
    cdsDetalle: TDAMemDataTable;
    dsMaestro: TDADataSource;
    dsDetalle: TDADataSource;
    dbpMaestro: TppDBPipeline;
    dbpDetalle: TppDBPipeline;
    repReportes: TppReport;
    ppHeaderBand1: TppHeaderBand;
    ppDetailBand1: TppDetailBand;
    ppFooterBand1: TppFooterBand;
    ExtraOptions1: TExtraOptions;
    rdaMaestro: TDARemoteDataAdapter;
    rdaDetalle: TDARemoteDataAdapter;
    cdsConfiguracion: TDAMemDataTable;
    RemoteServiceProxy: TRORemoteService;
    RemoteDataAdapterProxy: TDARemoteDataAdapter;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    Parametros: TParametros;
    function Server: IServiceCistemGas;
    function ServerProxy(Estacion: Integer): IServiceProxy;
    procedure Imprimir(SQL1, SQL2, Template, Documento, CampoJoin: String; Directo: Boolean = False; Impresora: String = '');
    procedure AbreDataSetsReportes(SQL1, SQL2: String);
  end;

var
  DMCistemGas: TDMCistemGas;

implementation
uses uDM;

{$R *.dfm}

{ TDMCistemGas }

procedure TDMCistemGas.AbreDataSetsReportes(SQL1, SQL2: String);
begin
  cdsMaestro.Close;
  cdsDetalle.Close;

  cdsMaestro.Fields.Clear;
  cdsDetalle.Fields.Clear;

  rdaMaestro.GetDataCall.ParamByName('SQL').AsString:=SQL1;
  rdaMaestro.GetDataCall.ParamByName('Parametros').AsComplexType:=Parametros;
  cdsMaestro.Open;

  if Trim(SQL2) <> '' then
  begin
    rdaDetalle.GetDataCall.ParamByName('SQL').AsString:=SQL2;
    rdaDetalle.GetDataCall.ParamByName('Parametros').AsComplexType:=Parametros;
    cdsDetalle.Open;
  end;
end;

procedure TDMCistemGas.DataModuleCreate(Sender: TObject);
const
  URLServer = 'http://%s:%s/BIN';
var
  HOSTVOLUMETRICO, PUERTOVOLUMETRICO: String;
begin
  cdsConfiguracion.Close;
  cdsConfiguracion.Open;
  cdsConfiguracion.Locate('NUMEROESTACION',DM.NumeroEstacion,[]);

  Parametros:=TParametros.Create;
  cdsConfiguracion.Close;
  cdsConfiguracion.Open;
  if (cdsConfiguracion.FieldByName('HOSTVOLUMETRICO').AsString <> '') then HOSTVOLUMETRICO:= cdsConfiguracion.FieldByName('HOSTFLOTILLAS').AsString
  else HOSTVOLUMETRICO:= '127.0.0.1';
  if (cdsConfiguracion.FieldByName('PUERTOVOLUMETRICO').AsString <> '') then PUERTOVOLUMETRICO:= cdsConfiguracion.FieldByName('PUERTOFLOTILLAS').AsString
  else PUERTOVOLUMETRICO:= '9002';

  Channel.TargetURL:=Format(URLServer, [HOSTVOLUMETRICO,PUERTOVOLUMETRICO]);
end;

procedure TDMCistemGas.Imprimir(SQL1, SQL2, Template, Documento,
  CampoJoin: String; Directo: Boolean; Impresora: String);
var
  Aux: TStringStream;
  lFieldLink: TppMasterFieldLink;
begin
  AbreDataSetsReportes(SQL1, SQL2);
  if CampoJoin <> '' then
  begin
    dbpDetalle.MasterDataPipeline := dbpMaestro;
    lFieldLink := TppMasterFieldLink.Create(nil);
    lFieldLink.Parent := dbpDetalle;
    lFieldLink.DetailFieldName := CampoJoin;
    lFieldLink.MasterFieldName := CampoJoin;
  end;
  Aux:=TStringStream.Create(Template);
  repReportes.Template.LoadFromStream(Aux);
  Aux.Free;
  repReportes.AllowPrintToFile:=True;
  repReportes.AllowPrintToArchive:=True;
  repReportes.PrinterSetup.DocumentName:=Documento;
  if Directo then
  begin
    if Impresora <> '' then
      repReportes.PrinterSetup.PrinterName:=Impresora;
    repReportes.DeviceType:='Printer';
    repReportes.ShowPrintDialog:=False;
  end
  else
  begin
    repReportes.DeviceType:='Screen';
    repReportes.ShowPrintDialog:=True;
  end;
  repReportes.NoDataBehaviors:=[ndBlankReport];
  repReportes.Print;
end;

function TDMCistemGas.Server: IServiceCistemGas;
begin
  Result:=CoServiceCistemGas.Create(Message, Channel);
end;

function TDMCistemGas.ServerProxy(Estacion: Integer): IServiceProxy;
const
  URL = 'http://%s:9001/BIN';
begin
  if not cdsConfiguracion.Active then
     cdsConfiguracion.Open;
  cdsConfiguracion.Locate('NUMEROESTACION', Estacion, []);
  Channel.TargetURL:=Format(URL, [cdsConfiguracion.FieldByName('HOSTVOLUMETRICO').AsString]);
  Result:=CoServiceProxy.Create(Message, Channel);
  //Result:=CoServiceProxy.Create(Message, Channel);
end;

end.
